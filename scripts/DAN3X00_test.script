# Build node name list
set NODE_DSP_NAMES dsp_tx_0 dsp_tx_1 dsp_rx_0 dsp_rx_1 dsp_rx_2 dsp_rx_3
set NODE_CPU_NAMES cpu_tx_0 cpu_tx_1 cpu_tx_2 cpu_tx_3 cpu_rx_0 cpu_rx_1 cpu_npu_0 cpu_npu_1 cpu_npu_2 cpu_npu_3 cpu_npu_4 cpu_npu_5
set NODE_ARM_NAMES arm_npu_0 arm_npu_1 arm_npu_2

set NODE_DSP_ITCMS 0xc4410000 0xc4510000 0xd4410000 0xd4510000 0xd4610000 0xd4710000
set NODE_CPU_ITCMS 0xc4010000 0xc4110000 0xc4210000 0xc4310000 0xd4110000 0xd4310000 0xe4010000 0xe4110000 0xe4210000 0xe4310000 0xe4410000 0xe4510000
set NODE_ARM_ITCMS 0xe4800000 0xe4a00000 0xe4c00000

set NODE_DSP_DTCMS 0xc4400000 0xc4500000 0xd4400000 0xd4500000 0xd4600000 0xd4700000
set NODE_CPU_DTCMS 0xc4000000 0xc4100000 0xc4200000 0xc4300000 0xd4100000 0xd4300000 0xe4000000 0xe4100000 0xe4200000 0xe4300000 0xe4400000 0xe4500000
set NODE_ARM_DTCMS 0xe4900000 0xe4b00000 0xe4d00000

set NODE_DSP_RESETS 0x1fc 0x204 0x20c 0x214 0x21c 0x224
set NODE_CPU_RESETS 0x22C 0x234 0x23C 0x244 0x24C 0x254 0x25C 0x264 0x26C 0x274 0x27C 0x284
set NODE_ARM_RESETS 0x28C 0x294 0x29C

set NODE_DSP_VERDICTS 0xc4700050 0xc470a050 0xd4900050 0xd490A050 0xd494C050 0xd4956050
set NODE_CPU_VERDICTS 0xc4720250 0xc472a250 0xc4740250 0xc474a250 0xd498A250 0xd491E250 0xe5700250 0xe5708250 0xe5710250 0xe5718250 0xe5740250 0xe5748250
set NODE_ARM_VERDICTS 0xe5732084 0xe5732088 0xe573208C

set SELF_VERDICT_ADDR 0xe5732090

set CLK_GEN_BASE 0xe573E000

set TFTP_COPY_TMP_ADDR 0x50400000
set idx 1

pll_on $ARG2
sleep -l 300000
# sleep -l 25000

if $ARG1 seq \$ARG1 goto NO_ARG
set TFTP_TEST_DIR $ARG1/
goto TOP_TFTP_LOOP
# NO_ARG:
set TFTP_TEST_DIR ./

# TOP_TFTP_LOOP:
item $idx NODE $NODE_DSP_NAMES $NODE_CPU_NAMES $NODE_ARM_NAMES
if $NODE seq \$NODE goto DO_RESET_NODES
item $idx ITCM $NODE_DSP_ITCMS $NODE_CPU_ITCMS $NODE_ARM_ITCMS
item $idx DTCM $NODE_DSP_DTCMS $NODE_CPU_DTCMS $NODE_ARM_DTCMS
item $idx RESET_OFFSET $NODE_DSP_RESETS $NODE_CPU_RESETS $NODE_ARM_RESETS
set NODE_RESET_$idx 0
# set DTCM_FILE_SUFFIX _dram0.data.bin
# set ITCM_FILE_SUFFIX _iram0.data.bin
set DTCM_FILE_SUFFIX _dtcm.data.bin
set ITCM_FILE_SUFFIX _itcm.data.bin
set DTCM_FILE_NAME $TFTP_TEST_DIR$NODE$DTCM_FILE_SUFFIX
set ITCM_FILE_NAME $TFTP_TEST_DIR$NODE$ITCM_FILE_SUFFIX
tftp $TFTP_SERVER_ADDR get $DTCM_FILE_NAME $TFTP_COPY_TMP_ADDR
if $TFTPGET seq \$TFTPGET goto NEXT_NODE
cm -4 $TFTP_COPY_TMP_ADDR $DTCM $TFTPGET
tftp $TFTP_SERVER_ADDR get $ITCM_FILE_NAME $TFTP_COPY_TMP_ADDR
if $TFTPGET seq \$TFTPGET goto NEXT_NODE
cm -4 $TFTP_COPY_TMP_ADDR $ITCM $TFTPGET
echo $NODE: $DTCM, $ITCM
set NODE_RESET_$idx $CLK_GEN_BASE
set -i -x NODE_RESET_$idx $RESET_OFFSET
# NEXT_NODE:
set -i idx
goto TOP_TFTP_LOOP

# DO_RESET_NODES:
set max $idx
set idx 1
set CLK_GEN_ADDR $CLK_GEN_BASE
set -i -x CLK_GEN_ADDR 0x54
pm -4 $CLK_GEN_ADDR 0x02220000
set -i -x CLK_GEN_ADDR 4
pm -4 $CLK_GEN_ADDR 0x3f3f0000
set -i -x CLK_GEN_ADDR 4
pm -4 $CLK_GEN_ADDR 0x00f30000

reg_test_prep.script

# TOP_RESET_LOOP:
if $idx ge $max goto CHECK_RESULT
if $NODE_RESET_$idx seq 0 goto NO_NODE_RESET
item $idx NODE $NODE_DSP_NAMES $NODE_CPU_NAMES $NODE_ARM_NAMES
echo Reset $NODE: $NODE_RESET_$idx
pm -4 $NODE_RESET_$idx 0xffff0000
pm -4 $NODE_RESET_$idx 0xffffffff
# NO_NODE_RESET:
set -i idx
goto TOP_RESET_LOOP

# CHECK_RESULT:
pm -4 $SELF_VERDICT_ADDR 0x2
sleep -m 1000
set idx 1

# TOP_CHECK_RESULT_LOOP:
item $idx NODE $NODE_DSP_NAMES $NODE_CPU_NAMES $NODE_ARM_NAMES
if $NODE seq \$NODE goto DONE
if $NODE_RESET_$idx seq 0 goto NO_NODE_RESULT
item $idx VERDICT_ADDR $NODE_DSP_VERDICTS $NODE_CPU_VERDICTS $NODE_ARM_VERDICTS
dm -4 -v VERDICT_VAL $VERDICT_ADDR
set -d -a VERDICT_VAL 0x7
set -d -i VERDICT_VAL 1
item $VERDICT_VAL VERDICT BAD RUNNING PASS FAIL BAD BAD BAD BAD 
echo \t$NODE \t- $VERDICT
set -i idx
goto TOP_CHECK_RESULT_LOOP
# NO_NODE_RESULT:
echo \t$NODE \t- Not Tested
set -i idx
goto TOP_CHECK_RESULT_LOOP
# DONE:
